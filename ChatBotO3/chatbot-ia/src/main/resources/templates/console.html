<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Consola - ChatBot IA</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Courier New', monospace;
            background: #1e1e1e;
            color: #e0e0e0;
            height: 100vh;
            display: flex;
            flex-direction: column;
        }

        .console-header {
            background: #2d2d30;
            padding: 15px;
            border-bottom: 2px solid #007acc;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .console-header h1 {
            font-size: 18px;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .console-title-bar {
            display: flex;
            gap: 10px;
        }

        .btn {
            background: #007acc;
            color: white;
            border: none;
            padding: 8px 15px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 12px;
            transition: all 0.3s;
        }

        .btn:hover {
            background: #005a9e;
        }

        .btn-secondary {
            background: #6c6c6c;
        }

        .btn-secondary:hover {
            background: #7e7e7e;
        }

        .console-content {
            flex: 1;
            overflow-y: auto;
            padding: 15px;
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        .console-line {
            display: flex;
            gap: 10px;
            animation: slideIn 0.2s ease-out;
        }

        @keyframes slideIn {
            from {
                opacity: 0;
                transform: translateX(-10px);
            }
            to {
                opacity: 1;
                transform: translateX(0);
            }
        }

        .console-prompt {
            color: #4ec9b0;
            flex-shrink: 0;
        }

        .console-input {
            color: #ce9178;
        }

        .console-output {
            color: #e0e0e0;
        }

        .console-error {
            color: #f48771;
        }

        .console-success {
            color: #89d185;
        }

        .console-info {
            color: #9cdcfe;
        }

        .input-section {
            padding: 15px;
            background: #2d2d30;
            border-top: 2px solid #007acc;
            display: flex;
            gap: 10px;
            align-items: center;
        }

        .input-prompt {
            color: #4ec9b0;
            flex-shrink: 0;
        }

        input[type="text"] {
            flex: 1;
            background: #1e1e1e;
            color: #e0e0e0;
            border: 1px solid #555;
            padding: 8px 10px;
            font-family: 'Courier New', monospace;
            font-size: 13px;
        }

        input[type="text"]:focus {
            outline: none;
            border-color: #007acc;
        }

        .help-text {
            font-size: 12px;
            color: #858585;
            margin-top: 10px;
            padding: 10px;
            background: #252526;
            border-left: 3px solid #007acc;
        }

        .scrollbar-thin::-webkit-scrollbar {
            width: 12px;
        }

        .scrollbar-thin::-webkit-scrollbar-track {
            background: #1e1e1e;
        }

        .scrollbar-thin::-webkit-scrollbar-thumb {
            background: #424242;
            border-radius: 6px;
        }

        .scrollbar-thin::-webkit-scrollbar-thumb:hover {
            background: #555;
        }

        .console-content {
            scrollbar-width: thin;
            scrollbar-color: #424242 #1e1e1e;
        }

        .loading {
            display: inline-block;
            width: 12px;
            height: 12px;
            border: 2px solid rgba(255, 255, 255, 0.3);
            border-top-color: white;
            border-radius: 50%;
            animation: spin 0.6s linear infinite;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }
    </style>
</head>
<body>
    <!-- Console Header -->
    <div class="console-header">
        <h1>⌨️ Consola de ChatBot IA</h1>
        <div class="console-title-bar">
            <button class="btn btn-secondary" onclick="goToUI()">GUI</button>
            <button class="btn btn-secondary" onclick="clearConsole()">Limpiar</button>
            <button class="btn btn-secondary" onclick="showHelp()">Ayuda</button>
        </div>
    </div>

    <!-- Console Content -->
    <div class="console-content scrollbar-thin" id="consoleContent">
        <div class="console-line">
            <span class="console-info">
                ╔══════════════════════════════════════════════════════════════════╗
            </span>
        </div>
        <div class="console-line">
            <span class="console-info">║ ChatBot IA - Consola Interactiva                                    ║</span>
        </div>
        <div class="console-line">
            <span class="console-info">║ Claude Sonnet 4 + MCP O3                                            ║</span>
        </div>
        <div class="console-line">
            <span class="console-info">║ Escribe /ayuda para ver comandos disponibles                        ║</span>
        </div>
        <div class="console-line">
            <span class="console-info">
                ╚══════════════════════════════════════════════════════════════════╝
            </span>
        </div>
    </div>

    <!-- Input Section -->
    <div class="input-section">
        <span class="input-prompt">➜ </span>
        <input 
            type="text" 
            id="consoleInput" 
            placeholder="Escribe tu mensaje o comando..." 
            onkeypress="handleKeyPress(event)"
            autocomplete="off"
        >
    </div>

    <script>
        const API_BASE = '/api';

        /**
         * Envía un comando o mensaje
         */
        async function sendCommand() {
            const input = document.getElementById('consoleInput');
            const command = input.value.trim();

            if (!command) return;

            // Mostrar lo que escribió el usuario
            printLine(command, 'input');
            input.value = '';

            // Procesar comando
            if (command.startsWith('/')) {
                handleCommand(command);
            } else {
                // Es un mensaje normal
                sendMessage(command);
            }
        }

        /**
         * Maneja comandos especiales
         */
        async function handleCommand(command) {
            const parts = command.toLowerCase().split(' ');
            const cmd = parts[0];

            switch (cmd) {
                case '/ayuda':
                    showHelp();
                    break;
                case '/historial':
                    loadHistory();
                    break;
                case '/limpiar':
                    clearHistory();
                    break;
                case '/status':
                    getStatus();
                    break;
                case '/tools':
                    listTools();
                    break;
                case '/mdx':
                    if (parts.length > 1) {
                        executeMDX(command.substring(5));
                    } else {
                        printLine('Uso: /mdx <consulta MDX>', 'error');
                    }
                    break;
                case '/ui':
                    goToUI();
                    break;
                case '/salir':
                    window.close();
                    break;
                default:
                    printLine(`Comando no reconocido: ${cmd}. Escribe /ayuda para ayuda.`, 'error');
            }
        }

        /**
         * Envía un mensaje al ChatBot
         */
        async function sendMessage(message) {
            try {
                printLine('Procesando...', 'info');

                const response = await fetch(`${API_BASE}/chat/message`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ message: message })
                });

                const data = await response.json();

                if (data.success) {
                    printLine('', 'output'); // Línea en blanco
                    printLine(data.response, 'output');
                    printLine('', 'output');
                } else {
                    printLine('ERROR: ' + data.error, 'error');
                }
            } catch (error) {
                printLine('ERROR: ' + error.message, 'error');
            }
        }

        /**
         * Muestra la ayuda
         */
        function showHelp() {
            printLine('', 'output');
            printLine('╔══════════════════════════════════════════════════════════════════╗', 'info');
            printLine('║ COMANDOS DISPONIBLES                                             ║', 'info');
            printLine('╚══════════════════════════════════════════════════════════════════╝', 'info');
            printLine('/ayuda              - Muestra este mensaje de ayuda', 'output');
            printLine('/historial          - Muestra el historial de conversación', 'output');
            printLine('/limpiar            - Limpia el historial de conversación', 'output');
            printLine('/status             - Muestra el estado del sistema', 'output');
            printLine('/tools              - Lista herramientas disponibles de MCP', 'output');
            printLine('/mdx <consulta>     - Ejecuta una consulta MDX directa', 'output');
            printLine('/ui                 - Abre la interfaz gráfica', 'output');
            printLine('/salir              - Cierra la consola', 'output');
            printLine('', 'output');
            printLine('EJEMPLOS:', 'success');
            printLine('  /status                              - Ver estado', 'output');
            printLine('  /tools                               - Listar herramientas MCP', 'output');
            printLine('  Hola, ¿cómo estás?                   - Mensaje normal a Claude', 'output');
            printLine('', 'output');
        }

        /**
         * Carga el historial
         */
        async function loadHistory() {
            try {
                const response = await fetch(`${API_BASE}/chat/history`);
                const data = await response.json();

                printLine('', 'output');
                printLine('HISTORIAL DE CONVERSACIÓN:', 'success');
                printLine('═════════════════════════════════════════════════════════════════', 'info');

                if (data.history && data.history.length > 0) {
                    data.history.forEach((msg, index) => {
                        const role = msg.role === 'USER' ? '[TÚ]' : '[CLAUDE]';
                        const roleClass = msg.role === 'USER' ? 'input' : 'success';
                        printLine(`${index + 1}. ${role}`, roleClass);
                        printLine(`   ${msg.content}`, 'output');
                        printLine('', 'output');
                    });
                } else {
                    printLine('No hay mensajes en el historial', 'info');
                }
            } catch (error) {
                printLine('ERROR: ' + error.message, 'error');
            }
        }

        /**
         * Limpia el historial
         */
        async function clearHistory() {
            if (!confirm('¿Estás seguro de que deseas limpiar el historial?')) {
                return;
            }

            try {
                const response = await fetch(`${API_BASE}/chat/clear`, {
                    method: 'POST'
                });

                const data = await response.json();

                if (data.success === 'true') {
                    printLine('✓ Historial limpiado correctamente', 'success');
                } else {
                    printLine('ERROR: ' + data.error, 'error');
                }
            } catch (error) {
                printLine('ERROR: ' + error.message, 'error');
            }
        }

        /**
         * Obtiene el estado del sistema
         */
        async function getStatus() {
            try {
                const response = await fetch(`${API_BASE}/ai/status`);
                const data = await response.json();

                printLine('', 'output');
                printLine('ESTADO DEL SISTEMA:', 'success');
                printLine('═════════════════════════════════════════════════════════════════', 'info');

                if (data.status) {
                    printLine(`Claude AI:      ${data.status.ai_enabled ? '✓ Activo' : '✗ Inactivo'}`, 'info');
                    printLine(`MCP O3:         ${data.status.mcp_enabled ? '✓ Activo' : '✗ Inactivo'}`, 'info');
                    printLine(`Contexto:       ${data.status.context_size} mensajes en memoria`, 'info');
                }
                printLine('', 'output');
            } catch (error) {
                printLine('ERROR: ' + error.message, 'error');
            }
        }

        /**
         * Lista las herramientas de MCP
         */
        async function listTools() {
            try {
                const response = await fetch(`${API_BASE}/ai/tools`);
                const data = await response.json();

                printLine('', 'output');
                printLine('HERRAMIENTAS MCP DISPONIBLES:', 'success');
                printLine('═════════════════════════════════════════════════════════════════', 'info');

                if (data.tools) {
                    printLine(data.tools, 'output');
                } else {
                    printLine('No hay herramientas disponibles', 'info');
                }
                printLine('', 'output');
            } catch (error) {
                printLine('ERROR: ' + error.message, 'error');
            }
        }

        /**
         * Ejecuta una consulta MDX
         */
        async function executeMDX(query) {
            try {
                printLine('Ejecutando consulta MDX...', 'info');

                const response = await fetch(`${API_BASE}/ai/execute-mdx`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ query: query })
                });

                const data = await response.json();

                printLine('', 'output');
                if (data.success) {
                    printLine('RESULTADO:', 'success');
                    printLine('═════════════════════════════════════════════════════════════════', 'info');
                    printLine(data.result, 'output');
                } else {
                    printLine('ERROR: ' + data.error, 'error');
                }
                printLine('', 'output');
            } catch (error) {
                printLine('ERROR: ' + error.message, 'error');
            }
        }

        /**
         * Imprime una línea en la consola
         */
        function printLine(text, type = 'output') {
            const consoleContent = document.getElementById('consoleContent');
            const line = document.createElement('div');
            line.className = `console-line`;

            if (type === 'input') {
                line.innerHTML = `<span class="console-prompt">➜ </span><span class="console-input">${escapeHtml(text)}</span>`;
            } else if (type === 'error') {
                line.innerHTML = `<span class="console-error">${escapeHtml(text)}</span>`;
            } else if (type === 'success') {
                line.innerHTML = `<span class="console-success">${escapeHtml(text)}</span>`;
            } else if (type === 'info') {
                line.innerHTML = `<span class="console-info">${escapeHtml(text)}</span>`;
            } else {
                line.innerHTML = `<span class="console-output">${escapeHtml(text)}</span>`;
            }

            consoleContent.appendChild(line);
            consoleContent.scrollTop = consoleContent.scrollHeight;
        }

        /**
         * Escapa caracteres HTML
         */
        function escapeHtml(text) {
            const map = {
                '&': '&amp;',
                '<': '&lt;',
                '>': '&gt;',
                '"': '&quot;',
                "'": '&#039;'
            };
            return text.replace(/[&<>"']/g, m => map[m]);
        }

        /**
         * Limpia la consola
         */
        function clearConsole() {
            document.getElementById('consoleContent').innerHTML = '';
            printLine('Consola limpiada', 'success');
        }

        /**
         * Va a la UI gráfica
         */
        function goToUI() {
            window.location.href = '/';
        }

        /**
         * Maneja la tecla Enter
         */
        function handleKeyPress(event) {
            if (event.key === 'Enter') {
                event.preventDefault();
                sendCommand();
            }
        }

        // Inicializar
        document.addEventListener('DOMContentLoaded', () => {
            document.getElementById('consoleInput').focus();
        });
    </script>
</body>
</html>
